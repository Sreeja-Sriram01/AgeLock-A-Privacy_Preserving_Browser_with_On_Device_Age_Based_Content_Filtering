<!DOCTYPE html>
<html>
<head>
  <title>AgeLock Browser</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      background-color: #f0f8ff;
    }
    
    .age-selection {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      background-color: #f0f8ff;
    }
    
    h1 {
      color: #0078d7;
      margin-bottom: 30px;
    }
    
    .age-options {
      display: flex;
      gap: 20px;
      margin-top: 20px;
    }
    
    .age-option {
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      width: 200px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: transform 0.2s;
      position: relative;
    }
    
    .age-option:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .age-option h2 {
      margin-top: 0;
      color: #0078d7;
    }
    
    .age-option ul {
      list-style: none;
      padding: 0;
      text-align: left;
    }
    
    .age-option li {
      margin: 10px 0;
      padding-left: 20px;
      position: relative;
    }
    
    .age-option li:before {
      content: "✓";
      position: absolute;
      left: 0;
      color: #0078d7;
    }
    
    .lock-icon {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 20px;
      color: #0078d7;
    }
    
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background-color: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      max-width: 500px;
      width: 90%;
      position: relative;
    }
    
    .close-button {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      cursor: pointer;
      color: #777;
    }
    
    .close-button:hover {
      color: #333;
    }
    
    .verification-step {
      margin-top: 20px;
    }
    
    .verification-step p {
      margin-bottom: 15px;
    }
    
    .verification-step input,
    .verification-step select {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }
    
    .verification-step button {
      background-color: #0078d7;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.2s;
    }
    
    .verification-step button:hover {
      background-color: #005fa3;
    }
    
    .hint {
      font-size: 12px;
      color: #777;
      font-style: italic;
    }
    
    .setup-button {
      background-color: #0078d7;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-bottom: 20px;
      transition: background-color 0.2s;
    }
    
    .setup-button:hover {
      background-color: #005fa3;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    /* PIN Buttons Styles */
    .pin-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 20px;
    }
    
    .pin-button {
      background-color: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 10px;
      font-size: 18px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .pin-button:hover {
      background-color: #e0e0e0;
    }
    
    .pin-button:active {
      background-color: #d0d0d0;
    }
    
    .clear-button {
      grid-column: span 3;
      background-color: #f8d7da;
      color: #721c24;
    }
    
    .clear-button:hover {
      background-color: #f5c6cb;
    }
    
    /* Enhanced Security Question Styles */
    .question-container {
      margin-bottom: 20px;
    }
    
    .enhanced-select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      background-color: #f9f9f9;
      margin-bottom: 15px;
      cursor: pointer;
      appearance: none;
      background-image: url('data:image/svg+xml;utf8,<svg fill="%23888" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 10px center;
    }
    
    .enhanced-select:focus {
      outline: none;
      border-color: #0078d7;
      box-shadow: 0 0 0 2px rgba(0, 120, 215, 0.2);
    }
    
    .answer-container {
      position: relative;
    }
    
    .answer-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      background-color: white;
      border: 1px solid #ddd;
      border-top: none;
      border-radius: 0 0 4px 4px;
      max-height: 150px;
      overflow-y: auto;
      z-index: 10;
      display: none;
    }
    
    .suggestion-item {
      padding: 10px;
      cursor: pointer;
    }
    
    .suggestion-item:hover {
      background-color: #f0f0f0;
    }
    
    .quick-answers {
      margin-top: 20px;
      background-color: #f0f8ff;
      padding: 15px;
      border-radius: 5px;
    }
    
    .quick-answers p {
      margin-top: 0;
      margin-bottom: 10px;
      font-weight: bold;
      color: #0078d7;
    }
    
    .answer-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .answer-button {
      background-color: #e1f5fe;
      border: 1px solid #b3e5fc;
      border-radius: 20px;
      padding: 8px 15px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .answer-button:hover {
      background-color: #b3e5fc;
    }
    
    .verify-button {
      background-color: #0078d7;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 20px;
      transition: background-color 0.2s;
      width: 100%;
    }
    
    .verify-button:hover {
      background-color: #005fa3;
    }
    
    .back-button {
      background-color: #f0f0f0;
      color: #333;
      border: 1px solid #ddd;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
      transition: background-color 0.2s;
      width: 100%;
    }
    
    .back-button:hover {
      background-color: #e0e0e0;
    }
    
    /* Security Question Setup Styles */
    .secondary-button {
      background-color: #f0f0f0;
      color: #333;
      border: 1px solid #ddd;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
      transition: background-color 0.2s;
      width: 100%;
    }
    
    .secondary-button:hover {
      background-color: #e0e0e0;
    }
    
    .add-question-form {
      background-color: #f9f9f9;
      padding: 15px;
      border-radius: 5px;
      margin-top: 20px;
      border: 1px solid #eee;
    }
    
    .add-question-form h3 {
      margin-top: 0;
      color: #0078d7;
      font-size: 18px;
    }
    
    .button-group {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }
    
    .no-questions-message {
      padding: 15px;
      background-color: #f8f8f8;
      border-radius: 5px;
      text-align: center;
      color: #777;
      font-style: italic;
    }
    
    .security-question-item {
      background-color: #f0f8ff;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 10px;
      position: relative;
      border-left: 4px solid #0078d7;
    }
    
    .security-question-item h4 {
      margin-top: 0;
      margin-bottom: 5px;
      color: #0078d7;
    }
    
    .security-question-item p {
      margin: 5px 0;
      color: #333;
    }
    
    .security-question-item .answer {
      font-weight: bold;
      color: #555;
    }
    
    .security-question-item .delete-button {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #f8d7da;
      color: #721c24;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 14px;
      line-height: 1;
      cursor: pointer;
    }
    
    .security-question-item .delete-button:hover {
      background-color: #f5c6cb;
    }
    
    .warning-message {
      background-color: #fff3cd;
      color: #856404;
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
      border-left: 4px solid #ffc107;
    }
    
    .browser-interface {
      display: none;
      flex-direction: column;
      height: 100%;
    }
    
    .browser-controls {
      display: flex;
      padding: 10px;
      background-color: #f0f0f0;
      border-bottom: 1px solid #ddd;
    }
    
    .url-bar {
      flex: 1;
      display: flex;
    }
    
    .url-bar input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px 0 0 4px;
    }
    
    .url-bar button {
      padding: 8px 15px;
      background-color: #0078d7;
      color: white;
      border: none;
      border-radius: 0 4px 4px 0;
      cursor: pointer;
    }
    
    .browser-status {
      display: flex;
      align-items: center;
      margin-left: 10px;
    }
    
    .age-indicator {
      background-color: #0078d7;
      color: white;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 14px;
    }
    
    .browser-content {
      flex: 1;
      position: relative;
    }
    
    .webview-container {
      width: 100%;
      height: 100%;
    }
    
    webview {
      width: 100%;
      height: 100%;
      border: none;
    }
    
    .loading-indicator {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #0078d7;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* Video Player Styles */
    .video-container {
      position: relative;
      width: 100%;
      height: 0;
      padding-bottom: 56.25%; /* 16:9 aspect ratio */
      background-color: #000;
      overflow: hidden;
    }
    
    #videoPlayer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #000;
      outline: none;
    }
    
    #videoPlayer:focus {
      outline: 2px solid #4a90e2;
      outline-offset: -2px;
      box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.5);
    }
    
    .video-controls {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      background-color: #1a1a1a;
      border-top: 1px solid #333;
      min-height: 50px;
    }
    
    .video-controls button {
      background: transparent;
      border: none;
      color: #fff;
      padding: 5px 10px;
      margin: 0 2px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
    }
    
    .video-controls button:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .video-controls button:active {
      transform: scale(0.95);
    }
    
    /* Custom range inputs */
    input[type="range"] {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      height: 4px;
      border-radius: 2px;
      background: #444;
      outline: none;
      margin: 10px 0;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #fff;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      background: #4a90e2;
    }
    
    #seekBar {
      flex-grow: 1;
      margin: 0 15px;
      height: 6px;
    }
    
    #seekBar::-webkit-slider-thumb {
      width: 16px;
      height: 16px;
    }
    
    #volumeBar {
      width: 80px;
      margin: 0 10px;
    }
    
    /* Loading spinner */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-spinner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-top: 4px solid #4a90e2;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      z-index: 10;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .video-controls {
        padding: 6px 8px;
      }
      
      .video-controls button {
        padding: 4px 8px;
        margin: 0 1px;
        width: 32px;
        height: 32px;
      }
      
      #volumeBar {
        width: 60px;
      }
      
      #currentTime, #duration {
        font-size: 12px;
        min-width: 40px !important;
      }
    }
    
    @media (max-width: 480px) {
      .video-controls {
        flex-wrap: wrap;
        padding: 4px;
      }
      
      #seekBar {
        order: 1;
        flex: 0 0 100%;
        margin: 5px 0;
      }
      
      .time-display {
        order: 2;
      }
      
      #volumeBar {
        width: 50px;
      }
    }
    .modal-content {
      max-width: 90%;
      max-height: 90%;
      background-color: #000;
      color: white;
    }
    
    .close-button {
      color: white;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Age Selection Screen -->
  <div class="age-selection" id="ageSelection">
    <h1>Welcome to AgeLock Browser</h1>
    <p>Please select your age range to continue:</p>
    
    <div style="background-color: #e7f3fe; border-left: 6px solid #2196F3; padding: 10px; margin: 15px 0; max-width: 600px; text-align: left;">
      <h3 style="margin-top: 0;">🔒 Privacy Guarantee</h3>
      <p><strong>All content filtering happens on your device.</strong> AgeLock never sends your browsing data or search queries to the cloud.</p>
      <p>Your privacy is our priority - no telemetry, no history collection, no cloud processing.</p>
    </div>
    
    <div class="age-options">
      <div class="age-option" onclick="selectAge('children')">
        <h2>Kids (5-12)</h2>
        <ul>
          <li>Educational websites</li>
          <li>Strict content filtering</li>
          <li>Parent-approved sites only</li>
        </ul>
      </div>
      
      <div class="age-option" onclick="showVerification('teenagers')">
        <h2>Teens (13-17)</h2>
        <ul>
          <li>Age-appropriate content</li>
          <li>Moderate content filtering</li>
          <li>Limited social media access</li>
        </ul>
        <div class="lock-icon">🔒</div>
      </div>
      
      <div class="age-option" onclick="showVerification('adults')">
        <h2>Adults (18+)</h2>
        <ul>
          <li>Full web access</li>
          <li>Minimal content filtering</li>
          <li>Privacy-focused browsing</li>
        </ul>
        <div class="lock-icon">🔒🔒</div>
      </div>
    </div>
    
    <!-- Age Verification Modal -->
    <div id="verificationModal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeVerification()">&times;</span>
        <h2 id="verificationTitle">Age Verification Required</h2>
        
        <!-- Step 1: PIN Verification (for both teenagers and adults) -->
        <div id="pinVerification" class="verification-step">
          <p>Please enter the parental control PIN to access this age range:</p>
          <input type="text" inputmode="numeric" id="pinInput" placeholder="Enter 4-digit PIN" maxlength="4" pattern="[0-9]*" autocomplete="off">
          <p class="hint" id="pinHint">Checking PIN status...</p>
          <button onclick="verifyPin()">Verify PIN</button>
          
          <!-- Alternative PIN buttons for touch input -->
          <div class="pin-buttons">
            <button type="button" class="pin-button" onclick="addPinDigit('1')">1</button>
            <button type="button" class="pin-button" onclick="addPinDigit('2')">2</button>
            <button type="button" class="pin-button" onclick="addPinDigit('3')">3</button>
            <button type="button" class="pin-button" onclick="addPinDigit('4')">4</button>
            <button type="button" class="pin-button" onclick="addPinDigit('5')">5</button>
            <button type="button" class="pin-button" onclick="addPinDigit('6')">6</button>
            <button type="button" class="pin-button" onclick="addPinDigit('7')">7</button>
            <button type="button" class="pin-button" onclick="addPinDigit('8')">8</button>
            <button type="button" class="pin-button" onclick="addPinDigit('9')">9</button>
            <button type="button" class="pin-button" onclick="addPinDigit('0')">0</button>
            <button type="button" class="pin-button clear-button" onclick="clearPin()">Clear</button>
          </div>
        </div>
        
        <!-- Step 2: Security Question (only for adults) -->
        <div id="securityQuestion" class="verification-step" style="display: none;">
          <h3>Security Question</h3>
          <p>Please answer the security question to access adult content.</p>
          
          <div class="form-group">
            <label for="questionSelect">Question:</label>
            <select id="questionSelect" class="enhanced-select">
              <option value="">Select a question...</option>
              <!-- Custom questions will be loaded here dynamically -->
            </select>
          </div>
          
          <div class="form-group">
            <label for="answerInput">Answer:</label>
            <input type="text" id="answerInput" placeholder="Enter your answer">
          </div>
          
          <div id="noQuestionsMessage" style="display: none;" class="warning-message">
            <p>No security questions have been set up yet. Please set up security questions first.</p>
            <button class="secondary-button" onclick="showSecuritySetup()">Set Up Security Questions</button>
          </div>
          
          <button class="verify-button" onclick="verifySecurityQuestion()">Verify</button>
          <button class="back-button" onclick="backToPin()">Back to PIN</button>
        </div>
      </div>
    </div>
    
    <!-- PIN Setup Modal -->
    <div id="pinSetupModal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closePinSetup()">&times;</span>
        <h2>Set Parental Control PIN</h2>
        
        <div class="verification-step">
          <p>This PIN will be required to access teenager and adult content.</p>
          
          <div class="form-group">
            <label for="currentPinInput">Current PIN:</label>
            <input type="password" id="currentPinInput" placeholder="Leave blank if using default" maxlength="4" pattern="[0-9]*">
          </div>
          
          <div class="form-group">
            <label for="newPinInput">New PIN:</label>
            <input type="password" id="newPinInput" placeholder="Enter 4-digit PIN" maxlength="4" pattern="[0-9]*">
          </div>
          
          <div class="form-group">
            <label for="confirmPinInput">Confirm PIN:</label>
            <input type="password" id="confirmPinInput" placeholder="Confirm 4-digit PIN" maxlength="4" pattern="[0-9]*">
          </div>
          
          <button onclick="saveNewPin()">Save PIN</button>
          <button class="secondary-button" onclick="showSecuritySetup()">Next: Set Security Questions</button>
        </div>
      </div>
    </div>
    
    <!-- Security Question Setup Modal -->
    <div id="securitySetupModal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeSecuritySetup()">&times;</span>
        <h2>Set Security Questions</h2>
        
        <div class="verification-step">
          <p>Set up security questions for adult content verification.</p>
          
          <div id="securityQuestionsList">
            <!-- Questions will be added here dynamically -->
            <div class="no-questions-message">No custom security questions set up yet.</div>
          </div>
          
          <div class="add-question-form">
            <h3>Add New Question</h3>
            
            <div class="form-group">
              <label for="questionTypeSelect">Question Type:</label>
              <select id="questionTypeSelect" class="enhanced-select">
                <option value="">Select a question type...</option>
                <option value="custom">Custom Question</option>
                <option value="maiden">What is your mother's maiden name?</option>
                <option value="pet">What was the name of your first pet?</option>
                <option value="city">In what city were you born?</option>
                <option value="school">What was the name of your first school?</option>
                <option value="car">What was your first car?</option>
              </select>
            </div>
            
            <div class="form-group" id="customQuestionGroup" style="display: none;">
              <label for="customQuestionInput">Custom Question:</label>
              <input type="text" id="customQuestionInput" placeholder="Enter your custom question">
            </div>
            
            <div class="form-group">
              <label for="questionAnswerInput">Answer:</label>
              <input type="text" id="questionAnswerInput" placeholder="Enter your answer">
            </div>
            
            <button onclick="addSecurityQuestion()">Add Question</button>
          </div>
          
          <div class="button-group">
            <button class="secondary-button" onclick="closeSecuritySetup()">Done</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Video Player Modal -->
  <div id="videoPlayerModal" class="modal" tabindex="-1" role="dialog" aria-labelledby="videoTitle" aria-hidden="true">
    <div class="modal-content" style="max-width: 95vw; max-height: 95vh; width: 100%; height: 100%; background-color: #000; padding: 0; display: flex; flex-direction: column; border-radius: 8px; overflow: hidden; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);">
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background-color: #111;">
        <h2 id="videoTitle" style="margin: 0; color: #fff; font-size: 16px; font-weight: normal; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; max-width: 80%;">Video Player</h2>
        <button onclick="closeVideoPlayer()" aria-label="Close video player" style="background: none; border: 1px solid transparent; color: #fff; font-size: 20px; cursor: pointer; padding: 4px 12px; border-radius: 4px; transition: all 0.2s ease;" onmouseover="this.style.backgroundColor='rgba(255,255,255,0.1)'" onmouseout="this.style.backgroundColor='transparent'" onfocus="this.style.backgroundColor='rgba(255,255,255,0.1)'" onblur="this.style.backgroundColor='transparent'">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="video-container">
        <video id="videoPlayer" style="width: 100%; height: 100%;" tabindex="0">
          Your browser does not support the video element.
        </video>
      </div>
      <div class="video-controls">
        <button onclick="togglePlayPause()" id="playPauseBtn" title="Play/Pause (Space/K)">
          <span style="font-size: 16px;">▶️</span>
        </button>
        <div style="flex-grow: 1; display: flex; align-items: center; margin: 0 10px;">
          <input type="range" id="seekBar" value="0" style="flex-grow: 1; margin: 0 10px;" title="Seek">
          <span id="currentTime" style="color: #fff; font-family: monospace; min-width: 50px; text-align: center;">0:00</span>
          <span style="color: #888; margin: 0 5px;">/</span>
          <span id="duration" style="color: #888; font-family: monospace; min-width: 50px; text-align: center;">0:00</span>
        </div>
        <button onclick="toggleMute()" id="muteBtn" title="Mute (M)">
          <span style="font-size: 16px;">🔊</span>
        </button>
        <input type="range" id="volumeBar" min="0" max="1" step="0.1" value="1" style="width: 80px; margin: 0 10px;" title="Volume">
        <button onclick="toggleFullscreen()" id="fullscreenBtn" title="Fullscreen (F)">
          <span style="font-size: 16px;">⛶</span>
        </button>
      </div>
      <div style="background-color: #111; color: #888; font-size: 12px; padding: 6px 10px; text-align: center; border-top: 1px solid #222;">
        <span class="keyboard-shortcut"><kbd>Space</kbd> Play/Pause</span>
        <span class="keyboard-shortcut"><kbd>←</kbd> <kbd>→</kbd> Seek 5s</span>
        <span class="keyboard-shortcut"><kbd>↑</kbd> <kbd>↓</kbd> Volume</span>
        <span class="keyboard-shortcut"><kbd>M</kbd> Mute</span>
        <span class="keyboard-shortcut"><kbd>F</kbd> Fullscreen</span>
        <span class="keyboard-shortcut"><kbd>ESC</kbd> Exit</span>
      </div>
      <style>
        .keyboard-shortcut {
          display: inline-flex;
          align-items: center;
          margin: 0 8px;
          white-space: nowrap;
        }
        kbd {
          background-color: #2a2a2a;
          border: 1px solid #444;
          border-radius: 3px;
          box-shadow: 0 1px 1px rgba(0,0,0,0.2);
          color: #fff;
          display: inline-block;
          font-family: monospace;
          font-size: 11px;
          line-height: 1.4;
          margin: 0 2px;
          padding: 1px 5px;
          white-space: nowrap;
        }
      </style>
    </div>
  </div>

  <!-- Browser Interface -->
  <div class="browser-interface" id="browserInterface">
    <div class="browser-controls">
      <form class="url-bar" id="urlForm">
        <input type="text" id="urlInput" placeholder="Enter URL or search query">
        <button type="submit">Go</button>
      </form>
      
      <div class="browser-status">
        <div class="age-indicator" id="ageIndicator">Age: Not Set</div>
      </div>
    </div>
    
    <div class="browser-content">
      <!-- Webview for browsing -->
      <div class="webview-container">
        <webview 
          id="browserFrame" 
          src="about:blank"
          allowpopups
          allowfullscreen
          allow="autoplay; fullscreen; picture-in-picture"
          webpreferences="allowRunningInsecureContent, javascript=yes, contextIsolation=no, nodeIntegration=no, webviewTag=yes, webSecurity=true, allowFileAccess=true, allowFileAccessFromFileURLs=true, allowUniversalAccessFromFileURLs=true, plugins=yes"
        ></webview>
      </div>
      
      <!-- Loading Indicator -->
      <div class="loading-indicator" id="loadingIndicator">
        <div class="spinner"></div>
        <p>Loading...</p>
      </div>
    </div>
  </div>
  
  <script>
    // DOM Elements
    const ageSelection = document.getElementById('ageSelection');
    const browserInterface = document.getElementById('browserInterface');
    const urlForm = document.getElementById('urlForm');
    const urlInput = document.getElementById('urlInput');
    const ageIndicator = document.getElementById('ageIndicator');
    const browserFrame = document.getElementById('browserFrame');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const verificationModal = document.getElementById('verificationModal');
    const verificationTitle = document.getElementById('verificationTitle');
    const pinVerification = document.getElementById('pinVerification');
    const securityQuestion = document.getElementById('securityQuestion');
    const pinInput = document.getElementById('pinInput');
    
    // Variables for verification
    const pinHint = document.getElementById('pinHint');
    const questionSelect = document.getElementById('questionSelect');
    const answerInput = document.getElementById('answerInput');
    const pinSetupModal = document.getElementById('pinSetupModal');
    const currentPinInput = document.getElementById('currentPinInput');
    const newPinInput = document.getElementById('newPinInput');
    const confirmPinInput = document.getElementById('confirmPinInput');
    
    // Store current age range and verification target
    let currentAgeRange = null;
    let verificationTarget = null;
    let isDefaultPin = true;
    
    // Check if age is already set and check PIN status
    window.onload = async function() {
      try {
        loadingIndicator.style.display = 'flex';
        
        // Check PIN status
        const pinResult = await window.api.getPin();
        if (pinResult.success) {
          isDefaultPin = pinResult.isDefault;
          console.log(`PIN status: ${isDefaultPin ? 'Default PIN' : 'Custom PIN'}`);
        }
        
        // Check age
        const result = await window.api.getAge();
        
        if (result.success && result.ageRange) {
          currentAgeRange = result.ageRange;
          ageSelection.style.display = 'none';
          browserInterface.style.display = 'flex';
          browserInterface.style.flexDirection = 'column';
          ageIndicator.textContent = `Age: ${currentAgeRange}`;
          
          // Load a welcome page
          browserFrame.src = 'about:blank';
          const welcomeHtml = `
            <html>
              <body style="font-family: Arial; padding: 20px; text-align: center; background-color: #f0f8ff;">
                <h1 style="color: #0078d7;">Welcome to AgeLock Browser</h1>
                <p>Your age range is set to: ${currentAgeRange}</p>
                <p>Enter a URL or search query in the bar above to start browsing</p>
                ${isDefaultPin ? `<p style="color: #e74c3c; font-weight: bold;">Warning: You are using the default PIN. For better security, please <a href="#" onclick="window.parent.showPinSetup(); return false;">set a custom PIN</a>.</p>` : ''}
              </body>
            </html>
          `;
          browserFrame.loadURL('data:text/html;charset=utf-8,' + encodeURIComponent(welcomeHtml));
        } else {
          // If using default PIN, show a setup button
          if (isDefaultPin) {
            const setupButton = document.createElement('button');
            setupButton.textContent = 'Set Parental Control PIN';
            setupButton.className = 'setup-button';
            setupButton.onclick = showPinSetup;
            ageSelection.insertBefore(setupButton, ageSelection.querySelector('.age-options'));
          }
        }
        
        loadingIndicator.style.display = 'none';
      } catch (error) {
        console.error('Error during initialization:', error);
        loadingIndicator.style.display = 'none';
      }
    };
    
    // Show verification modal for teenagers or adults
    function showVerification(ageRange) {
      console.log(`Showing verification for age range: ${ageRange}`);
      
      // Validate and normalize the age range
      if (!ageRange || typeof ageRange !== 'string') {
        console.error(`Invalid age range provided to showVerification: ${ageRange}`);
        alert('Error: Invalid age range');
        return;
      }
      
      // Normalize the age range
      const normalizedAgeRange = ageRange.trim().toLowerCase();
      
      // Validate the normalized age range
      if (!['teenagers', 'adults'].includes(normalizedAgeRange)) {
        console.error(`Invalid normalized age range: ${normalizedAgeRange}`);
        alert('Error: Invalid age range. Must be one of: teenagers, adults');
        return;
      }
      
      // Set the verification target
      verificationTarget = normalizedAgeRange;
      console.log(`Verification target set to: ${verificationTarget}`);
      
      // Set modal title based on age range
      verificationTitle.textContent = `Age Verification for ${normalizedAgeRange === 'teenagers' ? 'Teens (13-17)' : 'Adults (18+)'}`;
      
      // Reset verification inputs
      pinInput.value = '';
      questionSelect.value = '';
      answerInput.value = '';
      
      // Update PIN hint based on whether using default or custom PIN
      pinHint.textContent = isDefaultPin ? 'Default PIN: 1234' : 'Enter your custom parental control PIN';
      
      // Show appropriate verification steps
      pinVerification.style.display = 'block';
      securityQuestion.style.display = 'none';
      
      // Show the modal
      verificationModal.style.display = 'flex';
      
      // Focus on the PIN input field and ensure it's interactive
      setTimeout(() => {
        pinInput.focus();
        // Make sure the input field is enabled and not read-only
        pinInput.readOnly = false;
        pinInput.disabled = false;
        // Add a click handler to ensure focus
        pinInput.onclick = function() {
          this.focus();
        };
      }, 100);
    }
    
    // Close verification modal
    function closeVerification() {
      verificationModal.style.display = 'none';
      // Don't reset verificationTarget here as it's needed for selectAge
      console.log(`Closing verification modal, target remains: ${verificationTarget}`);
    }
    
    // Show PIN setup modal
    function showPinSetup() {
      // Reset form
      currentPinInput.value = '';
      newPinInput.value = '';
      confirmPinInput.value = '';
      
      // Show modal
      pinSetupModal.style.display = 'flex';
    }
    
    // Close PIN setup modal
    function closePinSetup() {
      pinSetupModal.style.display = 'none';
    }
    
    // Save new PIN
    async function saveNewPin() {
      const currentPin = currentPinInput.value.trim();
      const newPin = newPinInput.value.trim();
      const confirmPin = confirmPinInput.value.trim();
      
      // Validate inputs
      if (newPin.length < 4) {
        alert('PIN must be at least 4 digits');
        return;
      }
      
      if (newPin !== confirmPin) {
        alert('PINs do not match');
        return;
      }
      
      try {
        // Call API to set new PIN
        const result = await window.api.setPin({ pin: newPin, currentPin });
        
        if (result.success) {
          alert('PIN set successfully!');
          isDefaultPin = false;
          closePinSetup();
        } else {
          alert('Error setting PIN: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error setting PIN:', error);
        alert('An error occurred while setting the PIN. Please try again.');
      }
    }
    
    // Add a digit to the PIN input
    function addPinDigit(digit) {
      if (pinInput.value.length < 4) {
        pinInput.value += digit;
        // Flash the input to provide visual feedback
        pinInput.style.backgroundColor = '#e0f7fa';
        setTimeout(() => {
          pinInput.style.backgroundColor = '';
        }, 100);
      }
    }
    
    // Clear the PIN input
    function clearPin() {
      pinInput.value = '';
      pinInput.focus();
    }
    
    // Verify PIN
    async function verifyPin() {
      const pin = pinInput.value.trim();
      
      if (!pin) {
        alert('Please enter your PIN');
        return;
      }
      
      try {
        console.log(`Verifying PIN for age range: ${verificationTarget}`);
        
        // Make sure verificationTarget is valid
        if (!verificationTarget || !['teenagers', 'adults'].includes(verificationTarget)) {
          console.error(`Invalid verification target: ${verificationTarget}`);
          alert('Error: Invalid age range. Please try again.');
          return;
        }
        
        const result = await window.api.verifyPin({ pin, ageRange: verificationTarget });
        
        if (result.success) {
          // For adults, show security question verification
          if (verificationTarget === 'adults') {
            pinVerification.style.display = 'none';
            securityQuestion.style.display = 'block';
            
            // Load custom security questions
            await loadVerificationQuestions();
            
            // Focus on question select
            questionSelect.focus();
          } else {
            // For teenagers, PIN is enough
            // Store the target before closing the verification modal
            const targetToSelect = verificationTarget;
            console.log(`PIN verified, storing target: ${targetToSelect}`);
            
            // Close the verification modal
            closeVerification();
            
            // Use the stored target to select age
            console.log(`Selecting age range: ${targetToSelect}`);
            selectAge(targetToSelect);
          }
        } else {
          alert('Incorrect PIN. Please try again.');
          pinInput.value = '';
          pinInput.focus();
        }
      } catch (error) {
        console.error('Error verifying PIN:', error);
        alert('An error occurred while verifying the PIN. Please try again.');
      }
    }
    
    // Load security questions for verification
    async function loadVerificationQuestions() {
      try {
        const result = await window.api.getSecurityQuestions();
        const questionSelect = document.getElementById('questionSelect');
        const noQuestionsMessage = document.getElementById('noQuestionsMessage');
        
        // Clear existing options except the first one
        while (questionSelect.options.length > 1) {
          questionSelect.remove(1);
        }
        
        if (result.success && result.questions.length > 0) {
          // Hide no questions message
          noQuestionsMessage.style.display = 'none';
          
          // Add each question to the dropdown
          result.questions.forEach(q => {
            const option = document.createElement('option');
            option.value = q.question;
            option.textContent = q.question;
            questionSelect.appendChild(option);
          });
        } else {
          // Show no questions message
          noQuestionsMessage.style.display = 'block';
        }
      } catch (error) {
        console.error('Error loading verification questions:', error);
      }
    }
    
    // Set a quick answer for the security question
    function setQuickAnswer(answer) {
      answerInput.value = answer;
      // Add visual feedback
      answerInput.style.backgroundColor = '#e0f7fa';
      setTimeout(() => {
        answerInput.style.backgroundColor = '';
      }, 200);
    }
    
    // Go back to PIN verification step
    function backToPin() {
      pinVerification.style.display = 'block';
      securityQuestion.style.display = 'none';
      pinInput.value = '';
      pinInput.focus();
    }
    
    // Security question setup variables
    const securitySetupModal = document.getElementById('securitySetupModal');
    const questionTypeSelect = document.getElementById('questionTypeSelect');
    const customQuestionGroup = document.getElementById('customQuestionGroup');
    const customQuestionInput = document.getElementById('customQuestionInput');
    const questionAnswerInput = document.getElementById('questionAnswerInput');
    const securityQuestionsList = document.getElementById('securityQuestionsList');
    
    // Show security question setup modal
    function showSecuritySetup() {
      if (securitySetupModal) {
        securitySetupModal.style.display = 'block';
        // Reset form
        if (questionTypeSelect) questionTypeSelect.value = '';
        if (customQuestionInput) customQuestionInput.value = '';
        if (questionAnswerInput) questionAnswerInput.value = '';
        if (customQuestionGroup) customQuestionGroup.style.display = 'none';
        
        // Load existing questions
        loadSecurityQuestions();
      }
    }
    
    // Close security question setup modal
    function closeSecuritySetup() {
      if (securitySetupModal) {
        securitySetupModal.style.display = 'none';
        // Reset form
        if (questionTypeSelect) questionTypeSelect.value = '';
        if (customQuestionInput) customQuestionInput.value = '';
        if (questionAnswerInput) questionAnswerInput.value = '';
        if (customQuestionGroup) customQuestionGroup.style.display = 'none';
      }
    }
    
    // Load saved security questions
    async function loadSecurityQuestions() {
      try {
        const result = await window.api.getSecurityQuestions();
        
        if (result.success) {
          // Clear the list
          securityQuestionsList.innerHTML = '';
          
          if (result.questions.length === 0) {
            securityQuestionsList.innerHTML = '<div class="no-questions-message">No custom security questions set up yet.</div>';
          } else {
            // Add each question to the list
            result.questions.forEach((q, index) => {
              const questionItem = document.createElement('div');
              questionItem.className = 'security-question-item';
              questionItem.innerHTML = `
                <h4>Question ${index + 1}</h4>
                <p>${q.question}</p>
                <p class="answer">Answer: ${q.answer}</p>
                <button class="delete-button" onclick="deleteSecurityQuestion('${q.question}')">×</button>
              `;
              securityQuestionsList.appendChild(questionItem);
            });
          }
        } else {
          console.error('Failed to load security questions:', result.error);
        }
      } catch (error) {
        console.error('Error loading security questions:', error);
      }
    }
    
    // Handle question type selection
    questionTypeSelect.addEventListener('change', function() {
      if (this.value === 'custom') {
        customQuestionGroup.style.display = 'block';
        customQuestionInput.focus();
      } else {
        customQuestionGroup.style.display = 'none';
      }
    });
    
    // Add a new security question
    async function addSecurityQuestion() {
      try {
        let question;
        if (questionTypeSelect.value === 'custom') {
          question = customQuestionInput.value.trim();
        } else if (questionTypeSelect.value) {
          // Get the text of the selected option
          question = questionTypeSelect.options[questionTypeSelect.selectedIndex].text;
        } else {
          alert('Please select a question type');
          return;
        }
        
        const answer = questionAnswerInput.value.trim();
        
        if (!question) {
          alert('Please provide a question');
          return;
        }
        
        if (!answer) {
          alert('Please provide an answer');
          return;
        }
        
        // Save the question
        const result = await window.api.setSecurityQuestion({ question, answer });
        
        if (result.success) {
          // Reset form
          questionTypeSelect.value = '';
          customQuestionInput.value = '';
          questionAnswerInput.value = '';
          customQuestionGroup.style.display = 'none';
          
          // Reload questions
          loadSecurityQuestions();
        } else {
          alert(`Failed to save question: ${result.error}`);
        }
      } catch (error) {
        console.error('Error adding security question:', error);
        alert('An error occurred while saving the question');
      }
    }
    
    // Delete a security question
    async function deleteSecurityQuestion(questionText) {
      try {
        if (confirm('Are you sure you want to delete this security question?')) {
          // Get current questions
          const result = await window.api.getSecurityQuestions();
          
          if (result.success) {
            // Filter out the question to delete
            const updatedQuestions = result.questions.filter(q => q.question !== questionText);
            
            // Store the updated list
            await window.api.storeSecurityQuestions(updatedQuestions);
            
            // Reload questions
            loadSecurityQuestions();
          }
        }
      } catch (error) {
        console.error('Error deleting security question:', error);
        alert('An error occurred while deleting the question');
      }
    }
    
    // Verify security question (for adults only)
    async function verifySecurityQuestion() {
      const question = questionSelect.value;
      const answer = answerInput.value.trim();
      
      if (!question) {
        alert('Please select a security question');
        return;
      }
      
      if (!answer) {
        alert('Please provide an answer');
        return;
      }
      
      // Show verification in progress
      const verifyButton = document.querySelector('.verify-button');
      verifyButton.textContent = 'Verifying...';
      verifyButton.disabled = true;
      
      try {
        // Verify the answer
        const result = await window.api.verifySecurityQuestion({ question, answer });
        
        if (result.success) {
          // Show success feedback
          verifyButton.textContent = 'Verified ✓';
          verifyButton.style.backgroundColor = '#4caf50';
          
          // Wait a moment before proceeding
          setTimeout(() => {
            closeVerification();
            selectAge('adults');
          }, 500);
        } else {
          // Show error
          verifyButton.textContent = 'Incorrect Answer';
          verifyButton.style.backgroundColor = '#dc3545';
          verifyButton.disabled = false;
          
          // Reset after delay
          setTimeout(() => {
            verifyButton.textContent = 'Verify';
            verifyButton.style.backgroundColor = '#0078d7';
          }, 2000);
        }
      } catch (error) {
        console.error('Error verifying security question:', error);
        verifyButton.textContent = 'Error';
        verifyButton.style.backgroundColor = '#dc3545';
        verifyButton.disabled = false;
      }
    }
    
    // Initialize security question features
    function initSecurityQuestionFeatures() {
      // Add event listener for question type select
      if (questionTypeSelect) {
        questionTypeSelect.addEventListener('change', function() {
          if (this.value === 'custom') {
            customQuestionGroup.style.display = 'block';
            customQuestionInput.focus();
          } else if (this.value) {
            customQuestionGroup.style.display = 'none';
            questionAnswerInput.focus();
          }
        });
      }
      
      // Load any existing security questions
      loadSecurityQuestions();
    }
    
    // Call initialization when page loads
    document.addEventListener('DOMContentLoaded', function() {
      initSecurityQuestionFeatures();
      initVideoPlayer();
    });
    
    // Video Player Variables
    let videoPlayer;
    let playPauseBtn;
    let seekBar;
    let currentTimeDisplay;
    let durationDisplay;
    let muteBtn;
    let volumeBar;
    let fullscreenBtn;
    let videoPlayerModal;
    let isPlaying = false;
    let updateTimer;
    
    // Initialize Video Player
    function initVideoPlayer() {
      videoPlayer = document.getElementById('videoPlayer');
      playPauseBtn = document.getElementById('playPauseBtn');
      seekBar = document.getElementById('seekBar');
      currentTimeDisplay = document.getElementById('currentTime');
      durationDisplay = document.getElementById('duration');
      muteBtn = document.getElementById('muteBtn');
      volumeBar = document.getElementById('volumeBar');
      fullscreenBtn = document.getElementById('fullscreenBtn');
      videoPlayerModal = document.getElementById('videoPlayerModal');
      
      // Set up event listeners
      videoPlayer.addEventListener('play', updatePlayPauseButton);
      videoPlayer.addEventListener('pause', updatePlayPauseButton);
      videoPlayer.addEventListener('timeupdate', updateSeekBar);
      videoPlayer.addEventListener('loadedmetadata', updateDuration);
      videoPlayer.addEventListener('ended', videoEnded);
      
      playPauseBtn.addEventListener('click', togglePlayPause);
      seekBar.addEventListener('input', setCurrentTime);
      muteBtn.addEventListener('click', toggleMute);
      volumeBar.addEventListener('input', setVolume);
      fullscreenBtn.addEventListener('click', toggleFullscreen);
      
      // Hide default controls since we're using custom ones
      videoPlayer.removeAttribute('controls');
    }
    
    // Open video player with a video URL
    function openVideoPlayer(videoUrl) {
      if (!videoPlayer) initVideoPlayer();
      
      // Show loading state
      videoPlayer.poster = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cGF0aCBkPSJNMTIgMkM2LjQ4IDIgMiA2LjQ4IDIgMTJzNC40OCAxMCAxMCAxMCAxMC00LjQ4IDEwLTEwUzE3LjUyIDIgMTIgMnptLTEgMTRWOGw0IDQtNC00djhoMnYtNGwzIDNsLTMgM2gtNHoiIGZpbGw9IiNmZmYiLz4KPC9zdmc+Cg==';
      videoPlayerModal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      
      // Set source and load video
      videoPlayer.src = videoUrl;
      videoPlayer.load();
      
      // Set video title if available
      const titleElement = document.getElementById('videoTitle');
      if (titleElement) {
        try {
          const url = new URL(videoUrl);
          titleElement.textContent = url.hostname.replace('www.', '');
        } catch (e) {
          titleElement.textContent = 'Video Player';
        }
      }
      
      // Focus the video element for keyboard controls
      videoPlayer.focus();
      
      // Start playing when metadata is loaded
      videoPlayer.onloadedmetadata = function() {
        videoPlayer.play().catch(e => {
          console.error('Error playing video:', e);
          // Fallback to default controls if autoplay is blocked
          videoPlayer.controls = true;
        });
      };
      
      // Handle errors
      videoPlayer.onerror = function() {
        console.error('Error loading video:', videoUrl);
        alert('Error loading video. Please try another URL.');
        closeVideoPlayer();
      };
      
      // Add keyboard event listener for better accessibility
      document.addEventListener('keydown', handleVideoPlayerKeyDown);
    }
    
    // Close video player
    function closeVideoPlayer() {
      if (videoPlayer) {
        videoPlayer.pause();
        videoPlayer.src = '';
        videoPlayer.load();
        videoPlayer.controls = false; // Reset controls
      }
      videoPlayerModal.style.display = 'none';
      document.body.style.overflow = 'auto';
      clearInterval(updateTimer);
      
      // Remove keyboard event listener
      document.removeEventListener('keydown', handleVideoPlayerKeyDown);
      
      // Focus back to URL input for better UX
      if (urlInput) {
        urlInput.focus();
      }
    }
    
    // Toggle play/pause
    function togglePlayPause() {
      if (videoPlayer.paused || videoPlayer.ended) {
        videoPlayer.play().catch(e => {
          console.error('Error playing video:', e);
          // Fallback to default controls if autoplay is blocked
          videoPlayer.controls = true;
          videoPlayer.play().catch(console.error);
        });
      } else {
        videoPlayer.pause();
      }
    }
    
    // Update play/pause button
    function updatePlayPauseButton() {
      if (videoPlayer.paused || videoPlayer.ended) {
        playPauseBtn.textContent = 'Play';
        isPlaying = false;
      } else {
        playPauseBtn.textContent = 'Pause';
        isPlaying = true;
      }
    }
    
    // Update seek bar as video plays
    function updateSeekBar() {
      const value = (100 / videoPlayer.duration) * videoPlayer.currentTime;
      seekBar.value = value || 0;
      currentTimeDisplay.textContent = formatTime(videoPlayer.currentTime);
    }
    
    // Set video time based on seek bar
    function setCurrentTime() {
      const time = videoPlayer.duration * (seekBar.value / 100);
      videoPlayer.currentTime = time;
    }
    
    // Toggle mute
    function toggleMute() {
      videoPlayer.muted = !videoPlayer.muted;
      muteBtn.textContent = videoPlayer.muted ? 'Unmute' : 'Mute';
    }
    
    // Set volume
    function setVolume() {
      videoPlayer.volume = volumeBar.value;
      videoPlayer.muted = (volumeBar.value == 0);
      updateMuteButton();
    }
    
    // Update mute button based on volume
    function updateMuteButton() {
      if (videoPlayer.muted || videoPlayer.volume === 0) {
        muteBtn.textContent = 'Unmute';
      } else {
        muteBtn.textContent = 'Mute';
      }
    }
    
    // Toggle fullscreen
    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        // Enter fullscreen
        const element = videoPlayer;
        if (element.requestFullscreen) {
          element.requestFullscreen();
        } else if (element.webkitRequestFullscreen) { /* Safari */
          element.webkitRequestFullscreen();
        } else if (element.msRequestFullscreen) { /* IE11 */
          element.msRequestFullscreen();
        }
        fullscreenBtn.textContent = 'Exit Fullscreen';
      } else {
        // Exit fullscreen
        if (document.exitFullscreen) {
          document.exitFullscreen();
          fullscreenBtn.textContent = 'Fullscreen';
        }
      }
    }
    
    // Handle keyboard shortcuts for video player
    function handleVideoPlayerKeyDown(event) {
      // Don't trigger if typing in an input field
      if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
        return;
      }
      
      switch (event.key.toLowerCase()) {
        case ' ':
        case 'k':
          // Space or K toggles play/pause
          event.preventDefault();
          togglePlayPause();
          break;
          
        case 'm':
          // M toggles mute
          event.preventDefault();
          toggleMute();
          break;
          
        case 'f':
          // F toggles fullscreen
          event.preventDefault();
          toggleFullscreen();
          break;
          
        case 'arrowleft':
          // Left arrow seeks backward 5 seconds
          event.preventDefault();
          videoPlayer.currentTime = Math.max(0, videoPlayer.currentTime - 5);
          break;
          
        case 'arrowright':
          // Right arrow seeks forward 5 seconds
          event.preventDefault();
          videoPlayer.currentTime = Math.min(videoPlayer.duration, videoPlayer.currentTime + 5);
          break;
          
        case 'arrowup':
          // Up arrow increases volume
          event.preventDefault();
          videoPlayer.volume = Math.min(1, videoPlayer.volume + 0.1);
          updateMuteButton();
          break;
          
        case 'arrowdown':
          // Down arrow decreases volume
          event.preventDefault();
          videoPlayer.volume = Math.max(0, videoPlayer.volume - 0.1);
          updateMuteButton();
          break;
          
        case 'escape':
          // ESC exits fullscreen or closes the player
          if (document.fullscreenElement) {
            if (document.exitFullscreen) {
              document.exitFullscreen();
              fullscreenBtn.textContent = 'Fullscreen';
            }
          } else {
            closeVideoPlayer();
          }
          break;
          
        case '0':
        case '1':
        case '2':
        case '3':
        case '4':
        case '5':
        case '6':
        case '7':
        case '8':
        case '9':
          // Number keys 0-9 seek to percentage of video
          event.preventDefault();
          const percentage = parseInt(event.key) / 10;
          videoPlayer.currentTime = videoPlayer.duration * percentage;
          break;
      }
    }
    
    // Update video duration
    function updateDuration() {
      durationDisplay.textContent = formatTime(videoPlayer.duration);
      seekBar.max = 100;
    }
    
    // Handle video end
    function videoEnded() {
      playPauseBtn.textContent = 'Replay';
      isPlaying = false;
    }
    
    // Format time in seconds to MM:SS
    function formatTime(seconds) {
      const minutes = Math.floor(seconds / 60);
      seconds = Math.floor(seconds % 60);
      return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
    }
    
    // Select age range
    async function selectAge(ageRange) {
      try {
        console.log(`Setting age range to: ${ageRange}`);
        loadingIndicator.style.display = 'flex';
        
        // Validate age range before sending to API
        if (typeof ageRange !== 'string' || !['children', 'teenagers', 'adults'].includes(ageRange.trim().toLowerCase())) {
          alert(`Invalid age range: ${ageRange}. Must be one of: children, teenagers, adults`);
          loadingIndicator.style.display = 'none';
          return;
        }
        
        // Normalize the age range
        const normalizedAgeRange = ageRange.trim().toLowerCase();
        console.log(`Normalized age range: ${normalizedAgeRange}`);
        
        // Call API to set age
        const result = await window.api.setAge(normalizedAgeRange);
        
        if (result.success) {
          // Store age range locally
          currentAgeRange = ageRange;
          
          // Hide age selection, show browser interface
          ageSelection.style.display = 'none';
          browserInterface.style.display = 'flex';
          browserInterface.style.flexDirection = 'column';
          
          // Update age indicator
          ageIndicator.textContent = `Age: ${ageRange}`;
          
          // Load a welcome page
          browserFrame.src = 'about:blank';
          const welcomeHtml = `
            <html>
              <body style="font-family: Arial; padding: 20px; text-align: center; background-color: #f0f8ff;">
                <h1 style="color: #0078d7;">Welcome to AgeLock Browser</h1>
                <p>Your age range is set to: ${ageRange}</p>
                <p>Enter a URL or search query in the bar above to start browsing</p>
              </body>
            </html>
          `;
          browserFrame.loadURL('data:text/html;charset=utf-8,' + encodeURIComponent(welcomeHtml));
        } else {
          alert('Error setting age: ' + (result.error || 'Unknown error'));
        }
        
        loadingIndicator.style.display = 'none';
      } catch (error) {
        console.error('Error setting age:', error);
        alert('An error occurred while setting your age. Please try again.');
        loadingIndicator.style.display = 'none';
      }
    }
    
    // Check if URL points to a video file
    function isVideoUrl(url) {
      if (!url) return false;
      
      // Common video file extensions
      const videoExtensions = ['.mp4', '.webm', '.ogg', '.mov', '.m3u8', '.mpd', '.m3u', '.mp3', '.wav', '.aac', '.m4a', '.m4v', '.mkv', '.avi', '.wmv', '.flv', '.3gp'];
      
      // Check if URL ends with a video extension
      const lowerUrl = url.toLowerCase();
      return videoExtensions.some(ext => lowerUrl.endsWith(ext)) || 
             // Check for common video URL patterns
             /\/(?:videos?|streams?|embed|player)\//i.test(lowerUrl) ||
             /youtube\.com\/watch\?v=|youtu\.be\//i.test(lowerUrl) ||
             /vimeo\.com\//i.test(lowerUrl) ||
             /dailymotion\.com\/video\//i.test(lowerUrl) ||
             /twitch\.tv\/videos?\//i.test(lowerUrl) ||
             /facebook\.com\/[^/]+\/videos?\//i.test(lowerUrl) ||
             /instagram\.com\/p\/[^/]+\//i.test(lowerUrl) ||
             /tiktok\.com\/@[^/]+\/video\//i.test(lowerUrl) ||
             /netflix\.com\/watch\//i.test(lowerUrl) ||
             /hulu\.com\/watch\//i.test(lowerUrl) ||
             /disneyplus\.com\/video\//i.test(lowerUrl) ||
             /amazon\.(com|co\.uk|de|fr|it|es|jp|in|ca|com\.mx|com\.br|com\.au)\/([^/]+\/)?(dp|gp\/video\/detail)\/[A-Z0-9]+/i.test(lowerUrl);
    }
    
    // Handle URL submission
    async function handleUrlSubmit(event) {
      event.preventDefault();
      const url = urlInput.value.trim();
      
      if (!url) return;
      
      loadingIndicator.style.display = 'flex';
      
      // Check if input is a URL or a search query
      let processedUrl;
      
      if (isValidUrl(url)) {
        processedUrl = url;
        if (!processedUrl.startsWith('http://') && !processedUrl.startsWith('https://')) {
          processedUrl = 'https://' + processedUrl;
        }
        
        // Check if this is a video URL
        if (isVideoUrl(processedUrl)) {
          loadingIndicator.style.display = 'none';
          openVideoPlayer(processedUrl);
          return;
        }
        
        // Filter URL before loading
        try {
          const filterResult = await window.api.filterUrl(processedUrl);
          
          if (filterResult.blocked) {
            loadingIndicator.style.display = 'none';
            showBlockedContentMessage(filterResult.explanation || {
              category: 'restricted',
              reason: 'This website has been blocked based on your age settings.'
            });
            return;
          }
          
          // If it's a video sharing site, try to extract the video URL
          if (isVideoSharingSite(processedUrl)) {
            loadingIndicator.style.display = 'none';
            openVideoPlayer(processedUrl);
            return;
          }
          
          // Load URL in webview if not blocked and not a video
          browserFrame.src = processedUrl;
        } catch (error) {
          console.error('Error filtering URL:', error);
          loadingIndicator.style.display = 'none';
          alert('An error occurred while checking the URL. Please try again.');
        }
      } else {
        // Handle as search query
        console.log(`Searching for: ${url} with age range: ${currentAgeRange}`);
        
        // Filter search query before searching
        try {
          const filterResult = await window.api.filterText(url);
          
          if (filterResult.blocked) {
            loadingIndicator.style.display = 'none';
            showBlockedContentMessage(filterResult.explanation || {
              category: 'inappropriate',
              reason: 'This search query contains inappropriate content for your age range.'
            });
            return;
          }
          
          // Check if this is a video search
          const isVideoSearch = /\b(video|watch|stream|play|youtube|vimeo|dailymotion|twitch|netflix|hulu|disney|amazon.*video)\b/i.test(url);
          
          // Create a search URL based on age range
          let safeSearchParam = '';
          if (currentAgeRange === 'children') {
            safeSearchParam = '&safe=strict';
          } else if (currentAgeRange === 'teenagers') {
            safeSearchParam = '&safe=moderate';
          }
          
          const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(url)}${safeSearchParam}${isVideoSearch ? '&tbm=vid' : ''}`;
          browserFrame.src = searchUrl;
        } catch (error) {
          console.error('Error filtering search query:', error);
          loadingIndicator.style.display = 'none';
          alert('An error occurred while checking your search query. Please try again.');
        }
      }
    }
    
    // Check if URL is a video sharing site
    function isVideoSharingSite(url) {
      if (!url) return false;
      const lowerUrl = url.toLowerCase();
      return /(youtube\.com|youtu\.be|vimeo\.com|dailymotion\.com|twitch\.tv|facebook\.com\/[^/]+\/videos?|instagram\.com\/p\/[^/]+|tiktok\.com\/@[^/]+\/video|netflix\.com\/watch|hulu\.com\/watch|disneyplus\.com\/video|amazon\.(com|co\.uk|de|fr|it|es|jp|in|ca|com\.mx|com\.br|com\.au)\/([^/]+\/)?(dp|gp\/video\/detail)\/[A-Z0-9]+)/i.test(lowerUrl);
    }
    
    // Show blocked content message
    function showBlockedContentMessage(explanation) {
      // Create a blocked content message
      const blockedHtml = `
        <html>
          <body style="font-family: Arial; padding: 20px; text-align: center; background-color: #f0f8ff;">
            <div style="max-width: 600px; margin: 0 auto; background-color: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);">
              <h1 style="color: #e74c3c;">Content Blocked</h1>
              <div style="text-align: left; margin: 20px 0; padding: 15px; background-color: #f9f9f9; border-radius: 5px;">
                <h3 style="margin-top: 0; color: #e74c3c;">Why was this blocked?</h3>
                <p><strong>Category:</strong> ${explanation.category || 'Restricted Content'}</p>
                <p><strong>Reason:</strong> ${explanation.reason || 'This content is not appropriate for your age range.'}</p>
                ${explanation.matchingTerms ? `<p><strong>Matching terms:</strong> ${explanation.matchingTerms.join(', ')}</p>` : ''}
              </div>
              ${explanation.safeAlternatives ? `
                <div style="margin-top: 20px;">
                  <h3 style="color: #27ae60;">Try these safe alternatives instead:</h3>
                  <ul style="text-align: left;">
                    ${explanation.safeAlternatives.map(alt => `<li>${alt}</li>`).join('')}
                  </ul>
                </div>
              ` : ''}
              <p style="margin-top: 20px;">AgeLock is protecting you from content that may not be appropriate for your age range.</p>
              <button onclick="window.history.back()" style="background-color: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px;">Go Back</button>
            </div>
          </body>
        </html>
      `;
      
      // Display the blocked content message
      browserFrame.loadURL('data:text/html;charset=utf-8,' + encodeURIComponent(blockedHtml));
    }
    
    // Check if a string is a valid URL
    function isValidUrl(string) {
      try {
        new URL(string);
        return true;
      } catch (_) {
        // Check if it could be a valid URL with https:// prepended
        try {
          new URL('https://' + string);
          return string.includes('.') && !string.includes(' ');
        } catch (_) {
          return false;
        }
      }
    }
    
    // Event listeners
    urlForm.addEventListener('submit', handleUrlSubmit);
    
    // Add event listener for webview navigation to handle video links
    browserFrame.addEventListener('did-navigate', (event) => {
      const url = event.url || browserFrame.getURL();
      if (isVideoUrl(url)) {
        openVideoPlayer(url);
      }
    });
    
    // Handle video playback from within the webview
    browserFrame.addEventListener('dom-ready', () => {
      // Inject a script to detect video elements on the page
      browserFrame.executeJavaScript(`
        // Check for video elements on the page
        const videos = document.querySelectorAll('video, .video, [class*="video-"], [id*="video-"], [data-video]');
        if (videos.length > 0) {
          // If we find video elements, notify the main process
          window.postMessage({ type: 'VIDEO_DETECTED' }, '*');
        }
        
        // Also listen for dynamically added videos
        const observer = new MutationObserver((mutations) => {
          for (const mutation of mutations) {
            if (mutation.addedNodes.length > 0) {
              const hasVideo = Array.from(mutation.addedNodes).some(node => 
                node.nodeType === 1 && (
                  node.tagName === 'VIDEO' || 
                  node.classList && (
                    node.classList.contains('video') ||
                    Array.from(node.classList).some(cls => cls.includes('video'))
                  ) ||
                  node.id && node.id.includes('video') ||
                  node.hasAttribute('data-video')
                )
              );
              
              if (hasVideo) {
                window.postMessage({ type: 'VIDEO_DETECTED' }, '*');
                break;
              }
            }
          }
        });
        
        observer.observe(document.body, { childList: true, subtree: true });
      `);
    });
    
    // Listen for messages from the webview
    window.addEventListener('message', (event) => {
      if (event.data && event.data.type === 'VIDEO_DETECTED') {
        const currentUrl = browserFrame.getURL();
        if (isVideoUrl(currentUrl)) {
          openVideoPlayer(currentUrl);
        }
      }
    });
    
    // Webview event listeners
    browserFrame.addEventListener('did-start-loading', () => {
      loadingIndicator.style.display = 'flex';
    });
    
    browserFrame.addEventListener('did-stop-loading', () => {
      loadingIndicator.style.display = 'none';
      
      // Filter page content after loading
      filterPageContent();
    });
    
    // Filter page content after it loads
    async function filterPageContent() {
      try {
        // Only apply content filtering for children and teenagers
        if (currentAgeRange !== 'children' && currentAgeRange !== 'teenagers') {
          return;
        }
        
        // Execute script in webview to extract page content
        const pageContent = await browserFrame.executeJavaScript(`
          (function() {
            // Get all text content from the page
            const textContent = document.body ? document.body.innerText : '';
            
            // Get page title
            const pageTitle = document.title || '';
            
            // Get all image URLs
            const imageUrls = Array.from(document.images).map(img => img.src);
            
            // Get all link URLs
            const linkUrls = Array.from(document.links).map(link => link.href);
            
            // Get meta description
            const metaDescription = document.querySelector('meta[name="description"]') ?
              document.querySelector('meta[name="description"]').getAttribute('content') : '';
            
            // Get meta keywords
            const metaKeywords = document.querySelector('meta[name="keywords"]') ?
              document.querySelector('meta[name="keywords"]').getAttribute('content') : '';
            
            return {
              textContent,
              pageTitle,
              metaDescription,
              metaKeywords,
              imageUrls,
              linkUrls,
              url: window.location.href
            };
          })();
        `);
        
        // Combine all text content for filtering
        const allText = [
          pageContent.pageTitle,
          pageContent.metaDescription,
          pageContent.metaKeywords,
          pageContent.textContent
        ].join(' ');
        
        // Filter the combined text content
        const filterResult = await window.api.filterText(allText);
        
        if (filterResult.blocked) {
          console.log('Content blocked after page load:', filterResult);
          showBlockedContentMessage(filterResult.explanation || {
            category: filterResult.category || 'inappropriate',
            reason: 'This page contains content that is not appropriate for your age range.',
            matchingTerms: filterResult.explanation ? filterResult.explanation.matchingTerms : undefined
          });
          return;
        }
        
        // For search results pages, apply additional filtering
        if (pageContent.url.includes('google.com/search')) {
          // Get the search query from the URL
          const searchParams = new URLSearchParams(new URL(pageContent.url).search);
          const searchQuery = searchParams.get('q') || '';
          
          // Check if this is an educational search that should be allowed
          const educationalSearches = [
            'birds', 'animals', 'planets', 'space', 'science', 'math', 'history',
            'geography', 'dinosaurs', 'ocean', 'weather', 'plants', 'flowers',
            'insects', 'solar system', 'earth', 'moon', 'sun', 'stars', 'technology',
            'computers', 'books', 'reading', 'writing', 'art', 'music', 'sports',
            'health', 'food', 'nature', 'environment', 'recycling', 'countries',
            'continents', 'maps', 'transportation', 'vehicles', 'school'
          ];
          
          const isEducationalSearch = educationalSearches.some(term => 
            searchQuery.toLowerCase() === term || 
            searchQuery.toLowerCase().startsWith(term + ' ') || 
            searchQuery.toLowerCase().endsWith(' ' + term) || 
            searchQuery.toLowerCase().includes(' ' + term + ' ')
          );
          
          console.log(`Search query: "${searchQuery}", Educational: ${isEducationalSearch}`);
          
          // If this is an educational search, don't apply filtering
          if (isEducationalSearch) {
            // Just add an informational banner for educational searches
            await browserFrame.executeJavaScript(`
              (function() {
                // Add informational banner
                const infoDiv = document.createElement('div');
                infoDiv.style.backgroundColor = '#d4edda';
                infoDiv.style.color = '#155724';
                infoDiv.style.padding = '10px';
                infoDiv.style.margin = '10px 0';
                infoDiv.style.borderRadius = '5px';
                infoDiv.style.fontWeight = 'bold';
                infoDiv.textContent = 'AgeLock has verified this is an educational search. Enjoy learning!';
                
                // Insert at the top of search results
                const searchContainer = document.querySelector('#search');
                if (searchContainer && searchContainer.firstChild) {
                  searchContainer.insertBefore(infoDiv, searchContainer.firstChild);
                }
              })();
            `);
            return;
          }
          
          // For non-educational searches, apply filtering
          // Inject CSS to hide potentially inappropriate content
          await browserFrame.insertCSS(`
            ${currentAgeRange === 'children' ? `
              /* Hide image results for children */
              .hdtb-mitem:nth-child(2), /* Images tab */
              [data-content-feature="image"],
              img:not([src*="google"]) {
                display: none !important;
              }
            ` : ''}
            
            /* Apply content warnings */
            .g:has(.VwiC3b:contains("sex")),
            .g:has(.VwiC3b:contains("nude")),
            .g:has(.VwiC3b:contains("naked")),
            .g:has(.VwiC3b:contains("porn")),
            .g:has(.VwiC3b:contains("xxx")),
            .g:has(.VwiC3b:contains("adult content")),
            .g:has(.LC20lb:contains("sex")),
            .g:has(.LC20lb:contains("nude")),
            .g:has(.LC20lb:contains("naked")),
            .g:has(.LC20lb:contains("porn")),
            .g:has(.LC20lb:contains("xxx")),
            .g:has(.LC20lb:contains("adult content")) {
              display: none !important;
            }
          `);
          
          // Execute script to filter search results
          await browserFrame.executeJavaScript(`
            (function() {
              // List of inappropriate terms to filter
              const inappropriateTerms = [
                'sex', 'nude', 'naked', 'porn', 'xxx', 'adult content', 'erotic',
                'kill', 'murder', 'suicide', 'drug', 'cocaine', 'heroin',
                'hate', 'racist', 'nazi'
              ];
              
              // Function to check if text contains inappropriate terms
              function containsInappropriate(text) {
                if (!text) return false;
                text = text.toLowerCase();
                // Use word boundaries to match whole words only
                return inappropriateTerms.some(term => {
                  const regex = new RegExp('\\\\b' + term + '\\\\b', 'i');
                  return regex.test(text);
                });
              }
              
              // Filter search results
              const searchResults = document.querySelectorAll('.g');
              let blockedCount = 0;
              searchResults.forEach(result => {
                const title = result.querySelector('.LC20lb')?.textContent || '';
                const snippet = result.querySelector('.VwiC3b')?.textContent || '';
                
                if (containsInappropriate(title) || containsInappropriate(snippet)) {
                  result.style.display = 'none';
                  blockedCount++;
                }
              });
              
              // Add warning to the page
              const warningDiv = document.createElement('div');
              warningDiv.style.backgroundColor = '#f8d7da';
              warningDiv.style.color = '#721c24';
              warningDiv.style.padding = '10px';
              warningDiv.style.margin = '10px 0';
              warningDiv.style.borderRadius = '5px';
              warningDiv.style.fontWeight = 'bold';
              warningDiv.textContent = '${currentAgeRange === 'children' ? 
                `AgeLock is filtering these results to keep you safe. ${blockedCount} results have been hidden.` : 
                `AgeLock is filtering these results based on your age settings. ${blockedCount} results have been hidden.`}';
              
              // Insert at the top of search results
              const searchContainer = document.querySelector('#search');
              if (searchContainer && searchContainer.firstChild) {
                searchContainer.insertBefore(warningDiv, searchContainer.firstChild);
              }
            })();
          `);
        }
      } catch (error) {
        console.error('Error filtering page content:', error);
      }
    }

    // Load security questions for verification
    async function loadSecurityQuestionsForDropdown() {
      try {
        const result = await window.api.getSecurityQuestions();
        console.log('Loaded security questions:', result);
        const dropdown = document.getElementById('securityQuestionDropdown');
        if (!dropdown) return;
        dropdown.innerHTML = '';
        if (result.success && Array.isArray(result.questions) && result.questions.length > 0) {
          result.questions.forEach(q => {
            const option = document.createElement('option');
            option.value = q.question;
            option.textContent = q.question;
            dropdown.appendChild(option);
          });
        } else {
          const option = document.createElement('option');
          option.value = '';
          option.textContent = 'No security questions set';
          dropdown.appendChild(option);
        }
      } catch (error) {
        console.error('Error loading security questions for dropdown:', error);
      }
    }

    // Call this after setting up security questions
    async function afterSecurityQuestionsSetup() {
      await loadSecurityQuestionsForDropdown();
    }
  </script>
</body>
</html>
